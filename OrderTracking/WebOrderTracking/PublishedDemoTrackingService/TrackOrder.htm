<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title></title>
        <script type="text/javascript" src="jquery.js"></script>
        <script type="text/javascript" src="http://www.google.com/jsapi?key=YOUR_API_KEY_HERE"></script>
        <script type="text/javascript"charset="utf-8">google.load("maps","2.x"); google.load("jquery","1.3.1");</script>

        <style media="screen"type="text/css">#map { width:500px; height:500px; }</style>

        <script type="text/javascript">

            $().ready(function () {
                $.ajaxSetup({
                    error: DisplayError 
                });
            });

            function DisplayError(x, e) {
                    alert(e);
            }

            function DisplayCommsError(x, e) {
                $.ajaxSetup({
                    error: DisplayError
                });

                if (x.status == 0) {
                    alert('You are offline!!\n Please Check Your Network.' + e + ' ' + x.responseText);
                } else if (x.status == 404) {
                    alert('Requested URL not found.');
                } else if (x.status == 500) {
                    alert('Internel Server Error.' + x.responseText);
                } else if (e == 'parsererror') {
                    alert('Error.\nParsing JSON Request failed.');
                } else if (e == 'timeout') {
                    alert('Request Time out.');
                } else {
                    alert('Unknown Error.\n' + x.responseText);
                }
            }

            function Submit() {

                $.ajaxSetup({
                    error: DisplayCommsError
                });

                $.getJSON(
                    'http://192.168.40.128/DemoTrackingService/DemoTrackingService.svc/TrackOrder',
                    { customerCredentials: document.getElementById('credentials').value },
                    GotOrders);
            }

            function GotOrders(json) {

                $.ajaxSetup({
                    error: DisplayError
                });

 //               alert("Got Order");

                RefreshLastUpdated();

                if (json.orders.length > 0) {

                    var order = json.orders[0];

                    //                alert(json.Status);
                    $('span#orderStatus').text(GetOrderStatusText(order.Status));

                    //               alert(json.StoreLat);
                    $('span#storeLat').text(order.StoreLat);

                    //               alert(json.StoreLon);
                    $('span#storeLon').text(order.StoreLon);

                    //               alert(json.CustLat);
                    $('span#custLat').text(order.CustLat);

                    //               alert(json.CustLon);
                    $('span#custLon').text(order.CustLon);

                    //               alert(json.PersonProcessing);
                    $('span#personProcessing').text(order.PersonProcessing);

                    //               alert(json.Lat);
                    $('span#lat').text(order.Lat);

                    //               alert(json.Lon);
                    $('span#lon').text(order.Lon);
                }

 //               alert("Starting polling timer");

                window.setTimeout(DoPoll, 2000);

 //               alert("Got Order Finished");
            }

            function DoPoll() {

 //               alert("Poll");

                $.getJSON(
                    'http://192.168.40.128/DemoTrackingService/DemoTrackingService.svc/OrderLocation',
                    { customerCredentials: document.getElementById('credentials').value },
                    GotLocation);

                window.setTimeout(DoPoll, 2000);
            }

            function GotLocation(json) {

//                alert("Got Location");

                RefreshLastUpdated();

                if (json.orders.length > 0) {

                    var order = json.orders[0];

                    $('span#orderStatus').text(GetOrderStatusText(order.Status));
                    $('span#personProcessing').text(order.PersonProcessing);
                    $('span#lat').text(order.Lat);
                    $('span#lon').text(order.Lon);
                }

 //               alert("Got Location Finished");
            }

            function RefreshLastUpdated() {
                var now = new Date();
                var hours = now.getHours();
                var minutes = now.getMinutes();
                var seconds = now.getSeconds();

                $('span#lastUpdated').text(((hours < 10) ? "0" : "") + hours + ":" + ((minutes < 10) ? ":0" : ":") + minutes + ":" + ((seconds < 10) ? ":0" : ":") + seconds);
            }

            function GetOrderStatusText(orderStatus) {
                var statusText;

                switch (orderStatus) {
                    case "1":
                        statusText = "Order taken";
                        break;
                    case "2":
                        statusText = "Order made";
                        break;
                    case "3":
                        statusText = "Ready for dispatch";
                        break;
                    case "4":
                        statusText = "Out for delivery";
                        break;
                    case "5":
                        statusText = "Delivered";
                        break;
                    default:
                        statusText = "Unknown status";
                }

                return statusText;
            }

            function InitialiseMap() {
                var map = new GMap2(document.getElementById('map')); 
                var burnsvilleMN = new GLatLng(44.797916,-93.278046); 
                map.setCenter(burnsvilleMN, 8); 
            }

        </script>
    </head>
    <body>
        <h2>Order tracking demo site</h2>
        <label for="Credentials">Credentials:</label>
        <input type="text" id="credentials" />
        <input type="button" id="submitButton" onclick="Submit()" value="Submit" />
        <div>
            Last updated:<span id="lastUpdated"></span><br />
            Status:<span id="orderStatus"></span><br />
            Store lat:<span id="storeLat"></span><br />
            Store lon:<span id="storeLon"></span><br />
            Customer lat:<span id="custLat"></span><br />
            Customer lon:<span id="custLon"></span><br />
            Person processing:<span id="personProcessing"></span><br />
            Tracker lat:<span id="lat"></span><br />
            Tracker lon:<span id="lon"></span>
        </div>

        <div id="map"></div>
        
    </body>
</html>
